# ìŠ¤í”„ë§ DB 1í¸ - ë°ì´í„° ì ‘ê·¼ í•µì‹¬ ì›ë¦¬ - 4ê°• ìŠ¤í”„ë§ê³¼ ë¬¸ì œ í•´ê²° (íŠ¸ëœì­ì…˜)

# ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¡°

![Untitled](https://user-images.githubusercontent.com/61227459/187033569-a4831352-35cb-4f70-9d4a-631a175c773c.png)

ì„œë¹„ìŠ¤ ê³„ì¸µì„ **ìˆœìˆ˜í•˜ê²Œ ìœ ì§€**í•˜ëŠ” ê²ƒì´ ëª©í‘œ

â†’ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ì ì´ì§€ ì•Šê²Œ ê°œë°œ

# ë¬¸ì œ

1. íŠ¸ëœì­ì…˜ ë¬¸ì œ
2. ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ
3. JDBC ë°˜ë³µ ë¬¸ì œ

## ì½”ë“œ ì˜ˆì‹œ

### MemberServiceV1

```java
@RequiredArgsConstructor
public class MemberServiceV1 {
	private final MemberRepositoryV1 memberRepository;

	public void accountTransfer(String fromId, String toId, int money) throws SQLException {
		Member fromMember = memberRepository.findById(fromId);
		Member toMember = memberRepository.findById(toId);
		memberRepository.update(fromId, fromMember.getMoney() - money);
		memberRepository.update(toId, toMember.getMoney() + money);
	}
}
```

- `SQLException`
    - JDBC ê¸°ìˆ ì— ì˜ì¡´ì 
    - `memberRepository`ì—ì„œ í•´ê²°í•´ì•¼ í•¨
- `MemberRepositoryV1`ì´ë¼ëŠ” êµ¬ì²´ í´ë˜ìŠ¤ì— ì§ì ‘ ì˜ì¡´
    - `MemberRepository` ì¸í„°í˜ì´ìŠ¤ ë„ì…ìœ¼ë¡œ í•´ê²°

## íŠ¸ëœì­ì…˜ ë¬¸ì œ

- JDBC êµ¬í˜„ ê¸°ìˆ ì´ ì„œë¹„ìŠ¤ ê³„ì¸µì— ëˆ„ìˆ˜
- íŠ¸ëœì­ì…˜ ë™ê¸°í™”
    - ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì•¼ í•¨
    - ì´ë•Œ íŠ¸ëœì­ì…˜ì´ ì ìš©ë˜ëŠ” ê¸°ëŠ¥ê³¼ í•„ìš” ì—†ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ ë¶„ë¦¬ ë˜ì–´ì•¼ í•¨
- íŠ¸ëœì­ì…˜ ì ìš© ë°˜ë³µ
    - `try`, `catch`, `finally`

## ì˜ˆì™¸ ëˆ„ìˆ˜ ë¬¸ì œ

- ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì˜ JDBC êµ¬í˜„ ê¸°ìˆ  ì˜ˆì™¸ê°€ ì„œë¹„ìŠ¤ ê³„ì¸µìœ¼ë¡œ ì „íŒŒ
- `SQLException`
    - ë°ì´í„° ì ‘ê·¼ ê³„ì¸µì„ í˜¸ì¶œí•œ ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ í•´ë‹¹ ì˜ˆì™¸ë¥¼ ì¡ì•„ì„œ ì²˜ë¦¬
    - ëª…ì‹œì ìœ¼ë¡œ `throws`ë¥¼ í†µí•´ì„œ ë‹¤ì‹œ ë°–ìœ¼ë¡œ ë˜ì ¸ì•¼ í•¨
    - JDBC ì „ìš© ê¸°ìˆ  â†’ JPA ì ìš© ì‹œ JPAì— ë§ëŠ” ì˜ˆì™¸ ì²˜ë¦¬ í•´ì•¼í•¨

## JDBC ë°˜ë³µ ë¬¸ì œ

- ì½”ë“œ ë°˜ë³µì´ ë§ìŒ
    - `try`, `catch`, `finally`

# íŠ¸ëœì­ì…˜ ì¶”ìƒí™”

![Untitled 1](https://user-images.githubusercontent.com/61227459/187033554-34152b02-f95e-464e-b190-2a7b0b2d0fb4.png)

- ì„œë¹„ìŠ¤ëŠ” `TxManager`ë¼ëŠ” ì¸í„°í˜ì´ìŠ¤ì— ì˜ì¡´
- êµ¬í˜„ì²´ë¥¼ DIë¥¼ í†µí•´ ì£¼ì… ê°€ëŠ¥
- OCP ì›ì¹™ì„ ì§€í‚¬ ìˆ˜ ìˆê²Œ ë¨

<aside>
ğŸ’¡ **OCP(Open Closed Principle) :** ê¸°ì¡´ì˜ ì½”ë“œë¥¼ ë³€ê²½í•˜ì§€ ì•Šìœ¼ë©´ì„œ ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ê°€ ë˜ì–´ì•¼ í•œë‹¤.

</aside>

## ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ì¶”ìƒí™”


![Untitled 2](https://user-images.githubusercontent.com/61227459/187033556-bb429954-06dd-485c-a15f-675796f12ed1.png)

# íŠ¸ëœì­ì…˜ ë™ê¸°í™”


![Untitled 3](https://user-images.githubusercontent.com/61227459/187033558-b0c737da-bec4-4d1a-a692-2a8cb762b6c0.png)

1. íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” ë°ì´í„°ì†ŒìŠ¤ë¥¼ í†µí•´ ì»¤ë„¥ì…˜ì„ ë§Œë“¤ê³  íŠ¸ëœì­ì…˜ì„ ì‹œì‘
2. íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” íŠ¸ëœì­ì…˜ì´ ì‹œì‘ëœ ì»¤ë„¥ì…˜ì„ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— ë³´ê´€
3. ë¦¬í¬ì§€í† ë¦¬ëŠ” íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— ë³´ê´€ëœ ì»¤ë„¥ì…˜ì„ êº¼ë‚´ì„œ ì‚¬ìš©
4. íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë˜ë©´ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ëŠ” íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ì— ë³´ê´€ëœ ì»¤ë„¥ì…˜ì„ í†µí•´ íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œí•˜ê³ , ì»¤ë„¥ì…˜ë„ ë‹«ìŒ

# íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €

```java
private void close(Connection con, Statement stmt, ResultSet rs) {
	JdbcUtils.closeResultSet(rs);
	JdbcUtils.closeStatement(stmt);
	//ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
	DataSourceUtils.releaseConnection(con, dataSource);
}
private Connection getConnection() throws SQLException {
	//ì£¼ì˜! íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ DataSourceUtilsë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.
	Connection con = DataSourceUtils.getConnection(dataSource);
	log.info("get connection={} class={}", con, con.getClass());
	return con;
}
```

## `DataSourceUtils.getConnection()`

- `getConnection()`ì—ì„œ ë³€ê²½
- íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„¥ì…˜ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì»¤ë„¥ì…˜ì„ ë°˜í™˜
- íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„¥ì…˜ì´ ì—†ëŠ” ê²½ìš° ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ìƒì„±í•´ì„œ ë°˜í™˜

## `DataSourceUtils.releaseConnection()`

- `close()`ë¥¼ í™œìš©í•˜ë©´ ì»¤ë„¥ì…˜ì´ ìœ ì§€ ë˜ì§€ ì•ŠìŒ
    - ì»¤ë„¥ì…˜ì€ ì´í›„ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ì„ ì¢…ë£Œ(ì»¤ë°‹, ë¡¤ë°±)í•  ë•Œ ê¹Œì§€ ì‚´ì•„ìˆì–´ì•¼ í•¨
- íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë™ê¸°í™”ëœ ì»¤ë„¥ì…˜ì€ ì»¤ë„¥ì…˜ì„ ë‹«ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ìœ ì§€
    - íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬ í•˜ëŠ” ê²½ìš°
- íŠ¸ëœì­ì…˜ ë™ê¸°í™” ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ëŠ” ì»¤ë„¥ì…˜ì´ ì—†ëŠ” ê²½ìš° í•´ë‹¹ ì»¤ë„¥ì…˜ì„ ë‹«ìŒ

## ì˜ˆì‹œ

```java
public void accountTransfer(String fromId, String toId, int money) throws SQLException {
	//íŠ¸ëœì­ì…˜ ì‹œì‘
	//JDBC -> DataSourceTransactionManager
	TransactionStatus status = transactionManager.getTransaction(new DefaultTransactionDefinition());
	try {
		//ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
		bizLogic(fromId, toId, money);
		transactionManager.commit(status); //ì„±ê³µì‹œ ì»¤ë°‹
	} catch (Exception e) {
		transactionManager.rollback(status); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
		throw new IllegalStateException(e);
	}
}
```

### Test ì½”ë“œ

```java
@BeforeEach
void before() {
	DriverManagerDataSource dataSource = new DriverManagerDataSource(URL,	USERNAME, PASSWORD);
	//JDBCìš© íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € -> DataSourceTransactionManager
	PlatformTransactionManager transactionManager = new	DataSourceTransactionManager(dataSource);
	memberRepository = new MemberRepositoryV3(dataSource);
	memberService = new MemberServiceV3_1(transactionManager,	memberRepository);
}
```

![Untitled 4](https://user-images.githubusercontent.com/61227459/187033561-8dbdb2e5-1699-4f2d-9f04-c6e835207585.png)

![Untitled 5](https://user-images.githubusercontent.com/61227459/187033562-29951abc-37f7-40c7-95fa-c86c2f8542dd.png)

![Untitled 6](https://user-images.githubusercontent.com/61227459/187033563-59835002-3d00-4a94-b1f5-f0fbc62edcfe.png)

# íŠ¸ëœì­ì…˜ í…œí”Œë¦¿

## í…œí”Œë¦¿ ì½œë°± íŒ¨í„´

ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ì—­ì„ ì œì™¸í•œ ë°˜ë³µë˜ëŠ” ì„±ê³µ/ì‹¤íŒ¨ ë¡œì§

```java
public class TransactionTemplate {
	private PlatformTransactionManager transactionManager;
	public <T> T execute(TransactionCallback<T> action){..}
	void executeWithoutResult(Consumer<TransactionStatus> action){..}
}
```

- `execute()` : ì‘ë‹µ ê°’ì´ ìˆì„ ë•Œ ì‚¬ìš©
- `executeWithoutResult()` : ì‘ë‹µ ê°’ì´ ì—†ì„ ë•Œ ì‚¬ìš©

## ì˜ˆì‹œ

```java
private final TransactionTemplate txTemplate;
private final MemberRepositoryV3 memberRepository;

public MemberServiceV3_2(PlatformTransactionManager transactionManager,	MemberRepositoryV3 memberRepository) {
		this.txTemplate = new TransactionTemplate(transactionManager);
		this.memberRepository = memberRepository;
}

public void accountTransfer(String fromId, String toId, int money) throws SQLException {
	txTemplate.executeWithoutResult((status) -> {
		try {
			//ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
			//ë°˜ë³µë˜ëŠ” ì½”ë“œë“¤ì´ ì •ë¦¬ë¨
			bizLogic(fromId, toId, money);
		} catch (SQLException e) {
			throw new IllegalStateException(e);
		}
	});
}
```

<aside>
ğŸ’¡ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¡œì§ì´ ì•„ì§ ì„œë¹„ìŠ¤ ë‹¨ì— ìˆìŒ

</aside>

# íŠ¸ëœì­ì…˜ AOP

## í”„ë¡ì‹œë¥¼ í†µí•œ ë¬¸ì œ í•´ê²°


![Untitled 7](https://user-images.githubusercontent.com/61227459/187033564-0b4fa4e4-d01c-4cb3-8f68-ec7af3bbc2d8.png)

![Untitled 8](https://user-images.githubusercontent.com/61227459/187033567-3d0a70d6-2440-445d-ad27-bdbb3cb3ff86.png)

- íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ íŠ¸ëœì­ì…˜ ì²˜ë¦¬ ë¡œì§ì„ ëª¨ë‘ ê°€ì ¸ê°
- íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œ í›„ì— ì‹¤ì œ ì„œë¹„ìŠ¤ë¥¼ ëŒ€ì‹  í˜¸ì¶œ

<aside>
ğŸ’¡ @Transactional

</aside>

## ì˜ˆì‹œ

```java
@Transactional
public void accountTransfer(String fromId, String toId, int money) throws SQLException {
	bizLogic(fromId, toId, money);
}
```

### í…ŒìŠ¤íŠ¸ ì½”ë“œ

ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆë¥¼ í™œìš©í•´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ í•œ ê²ƒì´ ì•„ë‹ˆì–´ì„œ `@Transactional`ì„ í•´ë„ rollbackì´ ì•ˆë¨

**í…ŒìŠ¤íŠ¸ ì½”ë“œ ìˆ˜ì • í•„ìš”**

```java
1. @SpringBootTest -> í…ŒìŠ¤íŠ¸ ì‹œ Spring ìƒì„±
2. @TestConfiguration -> Bean ë“±ë¡ì„ ìœ„í•´
	 @Bean -> DataSource, PlatformTransactionManager, MemberRepositoryV3, MemberServiceV3_3
3. @Autowired -> ì˜ì¡´ ê´€ê³„ ì£¼ì… 
```

### AOP í”„ë¡ì‹œ í™•ì¸

```java
@Test
void AopCheck() {
	log.info("memberService class={}", memberService.getClass());
	log.info("memberRepository class={}", memberRepository.getClass());
	//í”„ë¡ì‹œ í™œìš©
	Assertions.assertThat(AopUtils.isAopProxy(memberService)).isTrue();
	//í”„ë¡ì‹œ í™œìš© X
	Assertions.assertThat(AopUtils.isAopProxy(memberRepository)).isFalse();
}
--------------------------------------------------------------------------------------
memberService class=class hello.jdbc.service.MemberServiceV3_3$$EnhancerBySpringCGLIB$$...
memberRepository class=class hello.jdbc.repository.MemberRepositoryV3
```

- `memberRepository`ì—ëŠ” AOPë¥¼ ì ìš©í•˜ì§€ ì•Šì•„ í”„ë¡ì‹œ(CGLIB) ì—†ìŒ
- íŠ¸ëœì­ì…˜ í”„ë¡ì‹œê°€ `memberService`ë¥¼ ìƒì† ë°›ì•„ ì½”ë“œë¥¼ ì¬ìƒì„±
    - ì¦‰, ì‹¤ì œ `memberService`ê°€ ì•„ë‹ˆë¼ í”„ë¡ì‹œ `memberService` í™œìš©
    - `@Autowired`ë„ í”„ë¡ì‹œì˜ `memberService` í˜¸ì¶œ
    - íŠ¸ëœì­ì…˜ í”„ë¡ì‹œ ì•ˆì— ì¡´ì¬í•˜ëŠ” `memberService`ë¥¼ í™œìš©í•  ë•Œ ì‹¤ì œ `memberService`ë¥¼ ë°©ë¬¸í•´ì„œ í™œìš©

![Untitled 9](https://user-images.githubusercontent.com/61227459/187033568-11d6ddf9-4489-4d1b-ae4e-b802c7410a84.png)

## ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬ vs í”„ë¡œê·¸ë˜ë° ë°©ì‹ íŠ¸ëœì­ì…˜ ê´€ë¦¬

### ì„ ì–¸ì  íŠ¸ëœì­ì…˜ ê´€ë¦¬

`@Transactional` ì• ë…¸í…Œì´ì…˜ í•˜ë‚˜ë§Œ ì„ ì–¸í•´ì„œ ë§¤ìš° í¸ë¦¬í•˜ê²Œ íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ëŠ” ê²ƒ

### í”„ë¡œê·¸ë˜ë° ë°©ì‹ íŠ¸ëœì­ì…˜ ê´€ë¦¬

íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì € ë˜ëŠ” íŠ¸ëœì­ì…˜ í…œí”Œë¦¿ ë“±ì„ ì‚¬ìš©í•´ì„œ íŠ¸ëœì­ì…˜ ê´€ë ¨ ì½”ë“œë¥¼ ì§ì ‘ ì‘ì„±í•˜ëŠ” ê²ƒ

# ìŠ¤í”„ë§ ë¶€íŠ¸ì˜ ìë™ ë¦¬ì†ŒìŠ¤ ë“±ë¡

<aside>
ğŸ’¡ ìŠ¤í”„ë§ì—ì„œëŠ” ë°ì´í„°ì†ŒìŠ¤ì™€ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë“±ë¡

</aside>

## DataSource

- `application.properties`ì— ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •

```java
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.username=sa
spring.datasource.password=
```

## PlatformTransactionManager

- JDBC â†’ `DataSourceTransactionManager`
- JPA â†’ `JpaTransactionManager`
- ë‘˜ ë‹¤ â†’ `JpaTransactionManager`