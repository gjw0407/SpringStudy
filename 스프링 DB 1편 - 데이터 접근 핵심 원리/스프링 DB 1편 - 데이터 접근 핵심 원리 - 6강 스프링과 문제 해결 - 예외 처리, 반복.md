# ìŠ¤í”„ë§ DB 1í¸ - ë°ì´í„° ì ‘ê·¼ í•µì‹¬ ì›ë¦¬ - 6ê°• ìŠ¤í”„ë§ê³¼ ë¬¸ì œ í•´ê²° - ì˜ˆì™¸ ì²˜ë¦¬, ë°˜ë³µ

# ì²´í¬ ì˜ˆì™¸ì™€ ì¸í„°í˜ì´ìŠ¤

<aside>
ğŸ’¡ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë„ì…í•˜ë”ë¼ë„ `SQLException`ê³¼ ê°™ì€ íŠ¹ì • êµ¬í˜„ ê¸°ìˆ ì— ì¢…ì†ì ì¸ ì²´í¬ ì˜ˆì™¸ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ì¸í„°í˜ì´ìŠ¤ì—ë„ í•´ë‹¹ ì˜ˆì™¸ë¥¼ í¬í•¨í•´ì•¼ í•¨

</aside>

## ëŸ°íƒ€ì„ ì˜ˆì™¸

<aside>
ğŸ’¡ ì¸í„°í˜ì´ìŠ¤ì— ëŸ°íƒ€ì„ ì˜ˆì™¸ë¥¼ ë”°ë¡œ ì„ ì–¸í•˜ì§€ ì•Šì•„ë„ ë¨ â†’ ì¸í„°í˜ì´ìŠ¤ê°€ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ì ì¼ í•„ìš”ê°€ ì—†ìŒ

</aside>

# ëŸ°íƒ€ì„ ì˜ˆì™¸ ì ìš©

MyDbExceptionì„ ìƒì„± í›„ ëŸ°íƒ€ì„ ì˜ˆì™¸ ìƒì†

```java
@Override
public Member save(Member member) {
	String sql = "insert into member(member_id, money) values(?, ?)";
	Connection con = null;
	PreparedStatement pstmt = null;
	try {
		con = getConnection();
		pstmt = con.prepareStatement(sql);
		pstmt.setString(1, member.getMemberId());
		pstmt.setInt(2, member.getMoney());
		pstmt.executeUpdate();
		return member;
	} catch (SQLException e) {
		// log.error();
		// throw e; 
		// ìœ„ ì½”ë“œë¥¼ ëŒ€ì²´
		throw new MyDbException(e);
	} finally {
		close(con, pstmt, null);
	}
}
```

- `SQLException` â†’ `MyDbException`ìœ¼ë¡œ êµí™˜
- ë©”ì„œë“œ ì˜†ì— `throws` ì œê±°
- í–¥í›„ JDBCì—ì„œ ë‹¤ë¥¸ êµ¬í˜„ ê¸°ìˆ ë¡œ ë³€ê²½í•˜ë”ë¼ë„ ì„œë¹„ìŠ¤ ê³„ì¸µì˜ ì½”ë“œë¥¼ ë³€ê²½í•˜ì§€ ì•Šê³  ìœ ì§€ ê°€ëŠ¥

# ë°ì´í„° ì ‘ê·¼ ì˜ˆì™¸ ì§ì ‘ ë§Œë“¤ê¸°

![Untitled](https://user-images.githubusercontent.com/61227459/187909059-64ee844e-d954-41fd-b962-3b5b0a0bc722.png)

## ì¤‘ë³µ PK ì˜ˆì™¸

```java
public class MyDuplicateKeyException extends MyDbException {
	public MyDuplicateKeyException() {
	}
	public MyDuplicateKeyException(String message) {
		super(message);
	}
	public MyDuplicateKeyException(String message, Throwable cause) {
		super(message, cause);
	}
	public MyDuplicateKeyException(Throwable cause) {
		super(cause);
	}
}
```

- ì´ ì˜ˆì™¸ëŠ” ì§ì ‘ ë§Œë“  ê²ƒì´ê¸° ë•Œë¬¸ì—, JDBCë‚˜ JPA ê°™ì€ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ì ì´ì§€ ì•ŠìŒ

## Test Code

```java
// Repository
} catch (SQLException e) {
	//h2 db
	if (e.getErrorCode() == 23505) {
	throw new MyDuplicateKeyException(e);
}
	throw new MyDbException(e);
}
```

- ì˜¤ë¥˜ ì½”ë“œê°€ í‚¤ ì¤‘ë³µ ì˜¤ë¥˜( 23505 )ì¸ ê²½ìš° `MyDuplicateKeyException`ì„ ìƒˆë¡œ ë§Œë“¤ì–´ì„œ ì„œë¹„ìŠ¤ ê³„ì¸µì— ë˜ì§
- ì´ì™¸ì˜ ê²½ìš° `MyDbException`ì— ë˜ì§

```java
// Service
try {
	repository.save(new Member(memberId, 0));
	log.info("saveId={}", memberId);
} catch (MyDuplicateKeyException e) {
	log.info("í‚¤ ì¤‘ë³µ, ë³µêµ¬ ì‹œë„");
	String retryId = generateNewId(memberId);
	log.info("retryId={}", retryId);
	repository.save(new Member(retryId, 0));
} catch (MyDbException e) {
	log.info("ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ ì˜ˆì™¸", e);
	throw e;
}
```

- `MyDbException`ì— ë¡œê·¸ë¥¼ ë‚¨ê¸°ì§€ ì•Šì•„ë„ ë¨
    - ì–´ì°¨í”¼ ë³µêµ¬í•  ìˆ˜ ì—†ëŠ” ì˜ˆì™¸ëŠ” ì˜ˆì™¸ë¥¼ ê³µí†µìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë¶€ë¶„ê¹Œì§€ ì „ë‹¬ ë¨
    - ë³µêµ¬ í•  ìˆ˜ ì—†ëŠ” ì˜ˆì™¸ëŠ” ê³µí†µìœ¼ë¡œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³³ì—ì„œ ì˜ˆì™¸ ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ” ê²ƒì´ ì¢‹ìŒ

# ìŠ¤í”„ë§ ì˜ˆì™¸ ì¶”ìƒí™”

![Untitled 1](https://user-images.githubusercontent.com/61227459/187909051-7d831009-f757-4048-b8ca-654b3d70c1ed.png)

- DataAccessExceptionì´ ìµœê³  ìƒìœ„

## DataAccessException

- Transient
    - ì¼ì‹œì 
    - ë™ì¼í•œ SQLì„ ì‹œë„í–ˆì„ ë–„ ì„±ê³µ ê°€ëŠ¥ì„± ìˆìŒ
    - ì¿¼ë¦¬ íƒ€ì„ì•„ì›ƒ, ë½ê³¼ ê´€ë ¨ëœ ì˜¤ë¥˜ â†’ DB ìƒíƒœê°€ ì¢‹ì•„ì§€ê±°ë‚˜ ë½ì´ í’€ë¦¬ë©´ ì‹¤í–‰ ê°€ëŠ¥
- NonTransient
    - ì¼ì‹œì ì´ì§€ ì•ŠìŒ
    - ê°™ì€ SQLì„ ë°˜ë³µí•´ì„œ ì‹¤í–‰í•˜ë©´ ì‹¤íŒ¨

# ì˜ˆì™¸ ë³€í™˜ê¸°

```jsx
@Test
 void sqlExceptionErrorCode() {
	 String sql = "select bad grammar";
	 try {
		 Connection con = dataSource.getConnection();
		 PreparedStatement stmt = con.prepareStatement(sql);
		 stmt.executeQuery();
	 } catch (SQLException e) {
		 assertThat(e.getErrorCode()).isEqualTo(42122);
		 //org.springframework.jdbc.BadSqlGrammarException
		 SQLExceptionTranslator exTranslator = new SQLErrorCodeSQLExceptionTranslator(dataSource);
		 DataAccessException resultEx = exTranslator.translate("select", sql, e);
		 log.info("resultEx", resultEx);
		 assertThat(resultEx.getClass()).isEqualTo(BadSqlGrammarException.class);
	 }
 }
```

- SQL ë¬¸ë²•ì´ ì˜ëª»ë˜ì–´ BadSqlGrammarException ë°˜í™˜
- ìŠ¤í”„ë§ì—ì„œ sql-error-codes.xmlë¡œ ì—ëŸ¬ ì½”ë“œ ê´€ë¦¬

# ìŠ¤í”„ë§ ì˜ˆì™¸ ì¶”ìƒí™” ì ìš©

```jsx
catch (SQLException e) {
 throw exTranslator.translate("save", sql, e);
}
```

- DI í™œìš©
    - ì„œë¹„ìŠ¤ ê³„ì¸µì€ íŠ¹ì • ë¦¬í¬ì§€í† ë¦¬ì˜ êµ¬í˜„ ê¸°ìˆ ê³¼ ì˜ˆì™¸ì— ì¢…ì†ì ì´ì§€ ì•ŠìŒ

# JDBC ë°˜ë³µ ë¬¸ì œ í•´ê²°

## JDBC ë°˜ë³µ ë¬¸ì œ

- ì»¤ë„¥ì…˜ ì¡°íšŒ, ì»¤ë„¥ì…˜ ë™ê¸°í™”
- PreparedStatement ìƒì„± ë° íŒŒë¼ë¯¸í„° ë°”ì¸ë”©
- ì¿¼ë¦¬ ì‹¤í–‰
- ê²°ê³¼ ë°”ì¸ë”©
- ì˜ˆì™¸ ë°œìƒì‹œ ìŠ¤í”„ë§ ì˜ˆì™¸ ë³€í™˜ê¸° ì‹¤í–‰
- ë¦¬ì†ŒìŠ¤ ì¢…ë£Œ

<aside>
ğŸ’¡ ìŠ¤í”„ë§ì€ JDBCì˜ ë°˜ë³µ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ `JdbcTemplate`ì´ë¼ëŠ” í…œí”Œë¦¿ì„ ì œê³µ

</aside>

```jsx
private final JdbcTemplate template;

public MemberRepositoryV5(DataSource dataSource) {
 template = new JdbcTemplate(dataSource);
}

@Override
public Member save(Member member) {
	String sql = "insert into member(member_id, money) values(?, ?)";
	template.update(sql, member.getMemberId(), member.getMoney());
	return member;
}
```