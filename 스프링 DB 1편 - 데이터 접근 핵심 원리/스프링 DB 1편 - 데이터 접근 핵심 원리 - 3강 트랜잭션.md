# ìŠ¤í”„ë§ DB 1í¸ - ë°ì´í„° ì ‘ê·¼ í•µì‹¬ ì›ë¦¬ - 3ê°• íŠ¸ëœì­ì…˜

# íŠ¸ëœì­ì…˜

<aside>
ğŸ’¡ í•˜ë‚˜ì˜ ê±°ë˜ê°€ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•˜ë„ë¡ ë³´ì¥ â†’ Commit, Rollback í˜•ì„±

</aside>

# íŠ¸ëœì­ì…˜ ACID

## ì›ìì„±

í•˜ë‚˜ì˜ ì‘ì—…ì²˜ëŸ¼ ë¬¶ëŠ” ê²ƒ â†’ ëª¨ë‘ ì„±ê³µ or ì‹¤íŒ¨

## ì¼ê´€ì„±

ëª¨ë“  íŠ¸ëœì­ì…˜ì€ ì¼ê´€ì„± ìˆëŠ” DB ì‚¬íƒœë¥¼ ìœ ì§€

## ê²©ë¦¬ì„±

ë™ì‹œì— ì‹¤í–‰ ë˜ëŠ” íŠ¸ëœì­ì…˜ì€ ì„œë¡œì—ê²Œ ì˜í–¥ì„ ì£¼ë©´ ì•ˆë¨

### ê²©ë¦¬ ìˆ˜ì¤€(Isolation level)

> ë™ì‹œì„±ê³¼ ê´€ë ¨ëœ ì´ìŠˆ ë•Œë¬¸ì— ê²©ë¦¬ ìˆ˜ì¤€ì„ ì„¤ì •
â†’ ë‹¤ ì§€í‚¤ë©´ ì„±ëŠ¥ì´ ëŠë ¤ì§
> 

### íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ - Isolation level

- READ UNCOMMITED(ì»¤ë°‹ë˜ì§€ ì•Šì€ ì½ê¸°)
- READ COMMITTED(ì»¤ë°‹ëœ ì½ê¸°)
- REPEATABLE READ(ë°˜ë³µ ê°€ëŠ¥í•œ ì½ê¸°)
- SERIALIZABLE(ì§ë ¬í™” ê°€ëŠ¥)

## ì§€ì†ì„±

íŠ¸ëœì­ì…˜ì„ ëë‚˜ë©´ ê¸°ë¡ì´ ë‚¨ì•„ì•¼ í•¨

# ì—°ê²° êµ¬ì¡°ì™€ DB ì„¸ì…˜

![Untitled](https://user-images.githubusercontent.com/61227459/186916370-13f972d0-b0dd-44a0-87c4-3ddb8eced5cd.png)

- í´ë¼ì´ì–¸íŠ¸ëŠ” ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ì— ì—°ê²°ì„ ìš”ì²­í•˜ê³  ì»¤ë„¥ì…˜ì„ ë§ºìŒ
- ë°ì´í„°ë² ì´ìŠ¤ ì„œë²„ëŠ” ë‚´ë¶€ì— ì„¸ì…˜ì´ë¼ëŠ” ê²ƒì„ ë§Œë“¦
    - ì»¤ë„¥ì…˜ì„ í†µí•œ ëª¨ë“  ìš”ì²­ì€ ì´ ì„¸ì…˜ì„ í†µí•´ì„œ ì‹¤í–‰

# DB ì˜ˆì œ

## Commit, Rollback

![Untitled 1](https://user-images.githubusercontent.com/61227459/186916374-d69400c2-b9db-4e45-a440-bc891fe37fd8.png)

â†’ ì»¤ë°‹ì„ í˜¸ì¶œí•˜ê¸° ì „ê¹Œì§€ëŠ” ì„ì‹œë¡œ ë°ì´í„°ë¥¼ ì €ì¥

**Commit ì‹¤í–‰ ì‹œ**


![Untitled 2](https://user-images.githubusercontent.com/61227459/186916377-b890339c-d939-400c-9ba0-2c7f4e106743.png)

**Rollback ì‹¤í–‰ ì‹œ**

![Untitled 3](https://user-images.githubusercontent.com/61227459/186916379-9dc924c0-5fcc-4247-9122-92a3f6d56ecb.png)

## ìë™, ìˆ˜ë™ commit

**ìë™ commit**

```sql
set autocommit true; //ìë™ ì»¤ë°‹ ëª¨ë“œ ì„¤ì •
```

**ìˆ˜ë™ commit**

```sql
set autocommit false; //ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œ ì„¤ì •
...
commit; //ìˆ˜ë™ ì»¤ë°‹
```

ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œë¡œ ì„¤ì • = íŠ¸ëœì­ì…˜ì„
ì‹œì‘

<aside>
ğŸ’¡ íŠ¸ëœì­ì…˜ì„ ì‹œì‘ : ìë™ ì»¤ë°‹ ëª¨ë“œì—ì„œ ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œë¡œ ì „í™˜

</aside>

# DB ë½

> ì„¸ì…˜ì´ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê³  ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë™ì•ˆì—ëŠ” ì»¤ë°‹ì´ë‚˜ ë¡¤ë°± ì „ê¹Œì§€ ë‹¤ë¥¸ ì„¸ì…˜ì—ì„œ í•´ë‹¹ ë°ì´í„°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ê²Œ ë§‰ì•„ì•¼ í•¨
>

![Untitled 4](https://user-images.githubusercontent.com/61227459/186916359-19d34cfb-d8c8-412d-a27c-253243207cdb.png)

```sql
SET LOCK_TIMEOUT 60000;
set autocommit false;
update member set money=1000 where member_id = 'memberA';
```

â†’ SET LOCK_TIMEOUT 60000 : ë½ íšë“ ì‹œê°„ì„ 60ì´ˆë¡œ ì„¤ì •í•œë‹¤. 60ì´ˆ ì•ˆì— ë½ì„ ì–»ì§€ ëª»í•˜ë©´ ì˜ˆì™¸ê°€
ë°œìƒí•œë‹¤.

## ì¡°íšŒ ë½

> ì¡°íšŒ ì¤‘ ë°ì´í„° ë³€ê²½ì´ ë˜ë©´ ì•ˆ ë˜ëŠ” ê²½ìš° ì¡°íšŒ ë½ì„ ì‚¬ìš©
> 

â†’ í•„ìš” ì‹œì— `select for update` êµ¬ë¬¸ì„ ì‚¬ìš© & í’€ê¸° ìœ„í•´ì„œëŠ” commit

# ì‹¤ìŠµ

![Untitled 5](https://user-images.githubusercontent.com/61227459/186916364-259a8166-e340-4bed-81dd-b1769d95831e.png)

<aside>
ğŸ’¡ ê°™ì€ ì»¤ë„¥ì…˜ì„ ìœ ì§€í•´ì•¼ ê°™ì€ ì„¸ì…˜ì„ ì‚¬ìš© í•  ìˆ˜ ìˆë‹¤

</aside>

## ì»¤ë„¥ì…˜

ì»¤ë„¥ì…˜ì„ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•´ì„œ ê°™ì€ ì»¤ë„¥ì…˜ì´ ì‚¬ìš©ë˜ë„ë¡ ìœ ì§€

```java
public void accountTransfer(String fromId, String toId, int money) throws SQLException {
	Connection con = dataSource.getConnection();
	try {
		con.setAutoCommit(false); //íŠ¸ëœì­ì…˜ ì‹œì‘
		//ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
		bizLogic(con, fromId, toId, money);
		con.commit(); //ì„±ê³µì‹œ ì»¤ë°‹
	} catch (Exception e) {
		con.rollback(); //ì‹¤íŒ¨ì‹œ ë¡¤ë°±
		throw new IllegalStateException(e);
	} finally {
		release(con);
	}
}

private void bizLogic(Connection con, String fromId, String toId, int money) throws SQLException {
	Member fromMember = memberRepository.findById(con, fromId);
	Member toMember = memberRepository.findById(con, toId);
	memberRepository.update(con, fromId, fromMember.getMoney() - money);
	validation(toMember);
	memberRepository.update(con, toId, toMember.getMoney() + money);
}
```

- ë©”ì„œë“œì—ì„œ `con = getConnection()` ì‚­ì œ â†’ ê°™ì€ ì»¤ë„¥ì…˜ì„ ìœ ì§€ í•˜ê¸° ìœ„í•´
- ë©”ì„œë“œëŠ” ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ì»¤ë„¥ì…˜ì„ ë‹«ìœ¼ë©´ ì•ˆë¨ â†’ ì„œë¹„ìŠ¤ ë¡œì§ì´ ëë‚  ë•Œ íŠ¸ëœì­ì…˜ ì¢…ë£Œ